{% extends 'tasks/base.html' %}
{% load dict_extras %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">Task Board</h2>
    <a href="{% url 'add_task' %}" class="btn btn-primary">Add Task</a>
</div>

{% for task in tasks %}
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <h5 class="card-title d-flex justify-content-between align-items-center">
        {{ task.title }}
        <span class="badge 
            {% if task.status == 'open' %}bg-success
            {% elif task.status == 'in_progress' %}bg-warning text-dark
            {% else %}bg-secondary{% endif %}">
            {{ task.get_status_display }}
        </span>
      </h5>

      <p class="mb-1 text-muted">Budget: ₹{{ task.budget }} | Deadline: {{ task.deadline }}</p>
      <p>{{ task.description }}</p>

      {% if task.user == request.user %}
          <a href="{% url 'edit_task' task.pk %}" class="btn btn-sm btn-outline-warning">Edit</a>
          <a href="{% url 'delete_task' task.pk %}" class="btn btn-sm btn-outline-danger">Delete</a>
      {% endif %}

      <!-- Show Apply form if not task owner -->
      {% if task.status == "open" and task.user != request.user %}
    {% if task.id in applied_task_ids %}
        <p class="text-success mt-3">✅ You have already applied to this task.</p>
    {% else %}
        <form method="POST" action="{% url 'apply_to_task' task.id %}" class="mt-3">
            {% csrf_token %}
            <textarea name="message" class="form-control mb-2" placeholder="Why are you a good fit?" required></textarea>
            <button type="submit" class="btn btn-primary">Apply</button>
        </form>
    {% endif %}
{% endif %}


      <!-- Show applicants only to task owner -->
      {% if task.user == request.user %}
        <h6 class="mt-4">Applicants:</h6>
        {% if applications|dictkey:task.id %}
          <ul class="list-group">
            {% for app in applications|dictkey:task.id %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <strong>{{ app.applicant.username }}</strong><br>
                  <small>{{ app.message }}</small>
                </div>
                <form method="post" action="{% url 'mark_in_progress' task.id app.applicant.id %}">
                  {% csrf_token %}
                  {% if task.status == "open" %}
                    <button class="btn btn-sm btn-outline-primary">Mark In Progress</button>
                  {% endif %}
                </form>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted">No applicants yet.</p>
        {% endif %}
      {% endif %}

    </div>
  </div>
{% empty %}
    <p>No tasks available.</p>
{% endfor %}

{% endblock %}
